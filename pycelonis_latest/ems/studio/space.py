"""Module to interact with spaces.

This module contains class to interact with a space in EMS Studio.

Typical usage example:

    ```python
    space = studio.get_space(space_id)
    space.name = "NEW_NAME"
    space.update()
    space.delete()
    ```
"""
import logging
import typing

from pycelonis.ems.studio.content_node import ContentNode
from pycelonis.ems.studio.content_node.package import Package
from pycelonis.service.package_manager.service import (
    ContentNodeType,
    PackageManagerService,
    SaveContentNodeTransport,
    SpaceDeleteTransport,
    SpaceSaveTransport,
    SpaceTransport,
)
from pycelonis.utils.yaml import dump_yaml
from pycelonis_core.base.collection import CelonisCollection
from pycelonis_core.client.client import Client
from pycelonis_core.utils.errors import PyCelonisNotFoundError
from pydantic.v1 import Field

logger = logging.getLogger(__name__)


class Space(SpaceTransport):
    """Space object to interact with space specific studio endpoints."""

    client: Client = Field(..., exclude=True)
    id: str
    """Id of space."""
    name: typing.Optional[str]
    """Name of space."""

    @classmethod
    def from_transport(cls, client: Client, space_transport: SpaceTransport) -> "Space":
        """Creates high-level space object from given SpaceTransport.

        Args:
            client: Client to use to make API calls for given space.
            space_transport: SpaceTransport object containing properties of space.

        Returns:
            A Space object with properties from transport and given client.
        """
        return cls(client=client, **space_transport.dict())

    def update(self) -> None:
        """Pushes local changes of space to EMS and updates properties with response from EMS."""
        updated_space = PackageManagerService.put_api_spaces_id(
            self.client, self.id, SpaceSaveTransport(**self.json_dict())
        )
        logger.info("Successfully updated space with id '%s'", self.id)
        self._update(updated_space)

    def sync(self) -> None:
        """Syncs space properties with EMS."""
        synced_space = PackageManagerService.get_api_spaces_id(self.client, self.id)
        self._update(synced_space)

    def delete(self) -> None:
        """Deletes space."""
        PackageManagerService.post_api_spaces_delete_id(self.client, self.id, SpaceDeleteTransport(**self.json_dict()))
        logger.info("Successfully deleted space with id '%s'", self.id)

    def __main_attributes__(self) -> typing.Optional[typing.List[str]]:
        return [
            "id",
            "name",
        ]

    ############################################################
    # Package
    ############################################################
    def create_package(self, name: str, key: typing.Optional[str] = None, **kwargs: typing.Any) -> "Package":
        """Creates new package with name in given space.

        Args:
            name: Name of new package.
            key: Key of new package. Defaults to name.
            **kwargs: Additional parameters set for
                [SaveContentNodeTransport][pycelonis.service.package_manager.service.SaveContentNodeTransport] object.

        Returns:
            A Package object for newly created package.

        Examples:
            Create a package in space:
            ```python
            space = c.studio.get_space("<space_id>")
            package = space.create_package(name="test-package")
            ```
        """
        key = key or name

        content_node_transport = PackageManagerService.post_api_nodes(
            self.client,
            SaveContentNodeTransport(
                name=name,
                key=key,
                space_id=self.id,
                node_type=ContentNodeType.PACKAGE,
                serialized_content=dump_yaml({"variables": [], "dependencies": []}),
                **kwargs,
            ),
        )
        logger.info("Successfully created package with id '%s'", content_node_transport.id)
        return typing.cast("Package", ContentNode.from_transport(self.client, content_node_transport))

    def get_package(self, id_: str) -> "ContentNode":
        """Gets package with given id.

        Args:
            id_: Id of package.

        Returns:
            A Package object for package with given id.

        Raises:
            PyCelonisNotFoundError: If no package with given id is located in space.
        """
        content_node_transport = PackageManagerService.get_api_nodes_id(self.client, id_)
        if content_node_transport.space_id != self.id or content_node_transport.node_type != ContentNodeType.PACKAGE:
            raise PyCelonisNotFoundError(f"No package with id '{id_}' found in space.")
        return ContentNode.from_transport(self.client, content_node_transport)

    def get_packages(self) -> CelonisCollection["ContentNode"]:
        """Gets all packages of given space.

        Returns:
            A list containing all packages.
        """
        content_node_transports = PackageManagerService.get_api_nodes_tree(self.client, self.id)
        return CelonisCollection(
            ContentNode.from_transport(self.client, content_node_transport)
            for content_node_transport in content_node_transports
            if content_node_transport is not None and ContentNode.is_package(content_node_transport)
        )

